# Ansible Playbook for Install Samba as Active Directory Server

This ansible will create Active Directory Server with samba.
You don't need Windows Server now!

## Install Samba

Edit hosts.inventory and run playbook:

    # ansible-playbook site.yml -i hosts.inventory

Administrator password is written in group_vars/samba-ad.yml

## Check working

### Active Directory

    # kinit administrator@MYDOMAIN.COM
    Password for administrator@MYDOMAIN.COM: <ENTER PASSWORD described in group_vars/samba-adc>
    Warning: Your password will expire in 41 days on Thu 28 Jun 2018 08:37:03 PM EDT

### LDAP

    # cp /var/lib/samba/private/tls/ca.pem /etc/pki/ca-trust/source/anchors/
    # update-ca-trust
    # yum install -y openldap-clients
    # ldapsearch -ZZ -x -D "cn=administrator,cn=users,dc=mydomain,dc=com" -w sysadmin0! -h pdc.mydomain.com -b "cn=users,dc=mydomain,dc=com" "(objectclass=*)" "sAMAccountName=username"

## Client Setting

Configure DNS for Samba AD.

### /etc/resolv.conf

    search localdomain mydomain.com
    nameserver 192.168.0.31 # your samba ad ip addrss

## User/Group Management

    # samba-tool user create okamototk
    # samba-tool group add mygroup
    # samba-tool group addmembers mygroup okamototk

## Add client to domain

    # net ads join -S dc.mydomain.com -U administrator
    Enter administrator's password:
    Using short domain name -- MYDOMAIN
    Joined 'CLIENT' to dns domain 'mydomain.com'



## Trouble Shooting

### Upper DNS doesn't work

Check dns forwarder configuration in /etc/samba/smb.conf

    [global]
            dns forwarder = 8.8.8.8

### Fail DNS update on client

    # net ads join -v -U administrator
    Enter administrator's password:
    Using short domain name -- MYDOMAIN
    Joined 'MYCLIENT' to dns domain 'mydomain.com'
    No DNS domain configured for myclient. Unable to perform DNS Update.
    DNS update failed: NT_STATUS_INVALID_PARAMETER

Please check client configuration. Check following site:

* https://lists.samba.org/archive/samba/2014-June/182437.html

### TLS error 

    # ldapsearch -ZZ -x -D "cn=administrator,cn=users,dc=domain,dc=com" -w sysadmin0! -h dc.domain.com -b "cn=users,dc=domain,dc=com" "(objectclass=*)" "sAMAccountName=username"
    ldap_start_tls: Connect error (-11)
            additional info: TLS: hostname does not match CN in peer certificate

Check CN in certificate by following command:

    # openssl s_client -showcerts -connect dc.domain.com:636
    CONNECTED(00000003)
    depth=1 O = Samba Administration, OU = Samba - temporary autogenerated CA certificate, CN = DC.mydomain.com
    verify return:1
    depth=0 O = Samba Administration, OU = Samba - temporary autogenerated HOST certificate, CN = DC.mydomain.com
    verify return:1
    ---
    Certificate chain
     0 s:/O=Samba Administration/OU=Samba - temporary autogenerated HOST certificate/CN=DC.mydomain.com
       i:/O=Samba Administration/OU=Samba - temporary autogenerated CA certificate/CN=DC.mydomain.com
    -----BEGIN CERTIFICATE---

If cert CN name and DC hostname is different. Remove /var/lib/samba/private/tls/* and run playbook again.